#!/usr/bin/env bash

begin() {
    printf " \033[0;33m➜\033[0m  %s\n" "$*"
}
success() {
    printf " \033[0;32m✔\033[0m  %s\n" "$*"
}
error() {
    printf " \033[0;31m✖\033[0m  %s\n" "$*"
}
end() {
    status=$?
    if [ $status -eq 0 ]; then
        success "Complete"
    else
        error "Error"
    fi
}
apt_install() {
    for app; do
        printf "\n"
        begin "Installing $app"
        if ! (dpkg --list | grep -w "$app" > /dev/null 2>&1); then
            sudo apt-get -y install "$app" > /dev/null 2>&1 || false
            end
        else
            success "Already installed"
        fi
    done
}
brew_install() {
    for app; do
        printf "\n"
        begin "Installing $app"
        if ! (brew list | grep -w "$app" > /dev/null 2>&1); then
            brew install "$app" > /dev/null 2>&1 || false
            end
        else
            success "Already installed"
        fi
    done
}
cask_install() {
    for app; do
        printf "\n"
        begin "Installing $app"
        if ! (brew cask list | grep -w "$app" > /dev/null 2>&1); then
            brew cask install "$app" > /dev/null 2>&1 || false
            end
        else
            success "Already installed"
        fi
    done
}
yum_install() {
    for app; do
        printf "\n"
        begin "Installing $app"
        if ! (rpm -qa | grep -w "$app" > /dev/null 2>&1); then
            sudo yum install -y "$app" > /dev/null 2>&1 || false
            end
        else
            success "Already installed"
        fi
    done
}
git_setup() {
    printf "\n"
    begin "Git configuration"
    read -rp "    Name: " gitName
    if [ ! -z "$gitName" ]; then
        git config --global user.name "$gitName"
    fi
    read -rp "    Email: " gitEmail
    if [ ! -z "$gitEmail" ]; then
        git config --global user.email "$gitEmail"
    fi
    git config --global color.ui auto
    git config --global core.editor "$(which vim)"
    git config --global core.autocrlf input
    git config --global push.default current
    git config --global alias.unstage 'reset HEAD --'
    git config --global alias.last 'log -1 HEAD'
    git config --global alias.co checkout
    git config --global alias.br branch
    git config --global alias.ci commit
    git config --global alias.s status
    git config --global alias.logp 'log --pretty=oneline --graph'
    end
}
setup_common() {
    printf "\n"
    begin "Linking dotfiles to your home directory"
    rcup -d ~/.dotfiles -x "*:*setup*" -x "*:*README*" -x "*:*docs*"
    end

    git_setup

    printf "\n"
    begin "Vim configuration"
    if [ ! -d ~/.vim/bundle/base16-vim ]; then
        git clone https://github.com/chriskempson/base16-vim.git ~/.vim/bundle/base16-vim > /dev/null 2>&1
    fi
    if [ ! -d ~/.vim/bundle/Vundle.vim ]; then
        git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim > /dev/null 2>&1
    fi
    vim +PluginInstall +qall
    end

    printf "\n\n\n"
    success "Script complete"
    printf "\n\n"
}
setup_debian() {
    sudo -v
    begin "Updating package list"
    sudo apt-get update > /dev/null 2>&1
    end

    printf "\n"
    apt_install $( cat "$DIR"/debian.lst )

    printf "\n"
    begin "Installing RCM"
    if [ "$( which lsrc )" ]; then
        success "Already installed"
    else
        rcmdeb=rcm_1.3.0-1_all.deb
        wget https://thoughtbot.github.io/rcm/debs/$rcmdeb > /dev/null 2>&1
        sha=$(sha256sum $rcmdeb | cut -f1 -d' ') > /dev/null 2>&1
        [ "$sha" = "2e95bbc23da4a0b995ec4757e0920197f4c92357214a65fedaf24274cda6806d" ] && sudo dpkg -i $rcmdeb > /dev/null 2>&1
        rm $rcmdeb
        end
    fi

    setup_common
}
setup_rhel() {
    sudo -v
    printf "\n"
    yum_install wget

    printf "\n"
    begin "Installing RCM"
    if (rpm -qa | grep -w rcm > /dev/null 2>&1); then
        success "Already installed"
    else
        cd /etc/yum.repos.d/ || exit
        sudo wget -q http://download.opensuse.org/repositories/utilities/RHEL_6/utilities.repo
        sudo yum -y install rcm > /dev/null 2>&1
        end
    fi

    printf "\n"
    begin "Installing RepoForge"
    if (rpm -qa | grep rpmforge > /dev/null 2>&1);then
        success "Already installed"
    else
        reporpm=rpmforge-release-0.5.3-1.el7.rf.x86_64.rpm
        wget -q http://apt.sw.be/redhat/el7/en/x86_64/rpmforge/RPMS/$reporpm
        sudo rpm --import http://dag.wiee.rs/packages/RPM-GPG-KEY.dag.txt > /dev/null 2>&1
        rpm -K $reporpm > /dev/null 2>&1 && sudo rpm -i $reporpm > /dev/null 2>&1
        rm $reporpm > /dev/null 2>&1
        end
    fi

    yum_install $( cat "$DIR"/rhel.lst )

    setup_common
}
setup_macos() {
    sudo -v
    printf "\n"
    begin "Configuring Hostname"
    read -rp "    Hostname: " name
    if [ -z "$name" ]; then
        success "Hostname unchanged"
    else
        sudo scutil --set ComputerName "$name"
        sudo scutil --set HostName "$name"
        sudo scutil --set LocalHostName "$name"
        sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string "$name"
        end
    fi

    printf "\n"
    begin "Installing Homebrew"
    if ! (which brew > /dev/null 2>&1); then
        ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" > /dev/null 2>&1
        end
    else
        success "Already installed"
        printf "\n"
        begin "Updating Homebrew"
        brew update > /dev/null 2>&1
        brew upgrade > /dev/null 2>&1
        end
    fi

    printf "\n"
    begin "Installing RCM"
    if ! (brew list | grep rcm > /dev/null 2>&1); then
        brew tap thoughtbot/formulae > /dev/null 2>&1
        brew install rcm > /dev/null 2>&1
        end
    else
        success "Already installed"
    fi

    brew_install $( cat "$DIR"/brew.lst )
    cask_install $( cat "$DIR"/cask.lst )

    printf "\n"
    begin "Brew cleanup"
    brew cleanup > /dev/null 2>&1
    end

    printf "\n"
    begin "Set GNU Bash as default"
    # Add the GNU shell to the list of allowed shells
    if ([ "$( grep -f '/etc/shells' '/usr/local/bin/bash' )" -ge 1 ]) > /dev/null 2>&1; then
        sudo bash -c 'echo /usr/local/bin/bash >> /etc/shells'
    fi
    # Change to the GNU shell
    sudo chsh -s /usr/local/bin/bash "$USER" > /dev/null 2>&1
    end

    setup_common
}

clear
printf "Dotfiles Setup Script\n=====================\n\n"

# Get script directory
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
    DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, resolve it
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

if ([ "$( uname -s )" = "Darwin" ]) > /dev/null 2>&1; then
    setup_macos
elif ([ "$( cat /etc/*release | grep -ciwE "debian|ubuntu" )" -ge 1 ]) > /dev/null 2>&1; then
    setup_debian
elif ([ "$( cat /etc/*release | grep -ciwE "red hat|centos" )" -ge 1 ]) > /dev/null 2>&1; then
    setup_rhel
else
    error "Unknown Distro - Manual install required\n"
    exit
fi
